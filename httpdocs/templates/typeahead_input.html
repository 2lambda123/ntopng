<form action="{{typeahead.action}}" data-bs-toggle="validator" class='form-inline my-2 my-md-0 my-xs-0 my-lg-0'>
<div class="control-group {{typeahead.class}}" style="{{typeahead.style}}">
  <div class="input-group">
      <button class="input-group-text"><i class="fas fa-search" aria-hidden="true"></i></button>
  {% for k,v in pairs(typeahead.parameters or {}) do %}
      <input type="hidden" name="{{k}}" value="{{v}}" />
  {% end %}
    <input id="{{typeahead.base_id}}_query" type="hidden" name="{{typeahead.query_field}}" data-ays-ignore="true"/>
    <input id="{{typeahead.base_id}}_search_field" type="text" data-minlength="1" class="form-control search-query span2" placeholder="{{typeahead.query_title}}" data-provide="typeahead" autocomplete="off"/>
  </div>
</div>

<script type='text/javascript'>
  var _typeahead_prototype = $.fn.typeahead.Constructor.prototype;
  var _typeahead_overridden_callbacks = {
    "click": null,
    "select": null,
  }

  /* Temporary override the typeahead click callback */
  for (var callback_name in _typeahead_overridden_callbacks) {
    /* Dump original callback */
    _typeahead_overridden_callbacks[callback_name] = _typeahead_prototype[callback_name];

    _typeahead_prototype[callback_name] = function() {
      if (this.$menu.find("> li[data-no-results]").length == 0) {
        /* invoke the original callback */
        _typeahead_overridden_callbacks[callback_name].apply(this, arguments);
      }
    };
  }
  let isButtonLinkClicked = false;

  function linkButtonClicked(url) {
      isButtonLinkClicked = true;
      window.location = url;
      //ntopng_url_manager.replace_url_and_reload(url);
  }

  $('#{{typeahead.base_id}}_search_field').typeahead({
      items: {*typeahead.max_items or 8*}, /* Max num of items, use "'all'" for unlimited */
      //item: '<li><a href="#" class="dropdown-item"></a> <div>asd</div></li>'.
      highlighter: function (item) {
	  // <a href="#" class="dropdown-item">${item}</a>
	  let query = `(${this.$element.val()})`;
	  let regex = new RegExp(query, "gi");
	  let itemHtml = item.replace(regex, "<strong>$1</strong>");
          var parts = item.split('#');
	  let printLinksButtons = (links) => {
	      if (links == null) { return ""; }
	      let linksButtons = [];
	      links.forEach((l) => {
		  let icon = "fa fas fa-link";
		  if (l.icon != null) {
		      icon = `fa fas fa-${l.icon}`;		      
		  }
		  let b = `<button type="button" class="btn btn-sm btn-link" style="text-align:right;" onClick="linkButtonClicked('${l.url}')"><i class="${icon}"></i></button>`;
		  linksButtons.push(b);
	      });
	      return linksButtons.join("");
	  };
	  let linksButtonsHtml = printLinksButtons(this.linksElementsDict[item]);
	  let html = `<li>
<div class="display:inline-block:">
<label><a href="#" class="dropdown-item">${itemHtml}</a></label>
${linksButtonsHtml}
</div>
</li>`;
          return html;
      },
      linksElementsDict: {},
      isButtonClicked: false,
      source: function (query, process) {
      /* Avoid this kind of queries which generates file path warnings into the ntopng log */
      if (query.startsWith(".")) return;
	  let me = this;

      var _get = {};
    {% for k,v in pairs(typeahead.parameters or {}) do %}
      _get["{{k}}"] = "{{v}}";
    {% end %}
      _get["query"] = query;
	  return $.get("{*typeahead.query_url*}", _get, function (data) {
	      let elements = data.rsp.results;
	      me.linksElementsDict = {};
	      elements.forEach((e) => {
		  if (e.links != null) {
		      //e.links.push({icon: "fas fa-search-minus", url: "ntop.org"});
		      me.linksElementsDict[e.name] = e.links;
		  }
	      });
              var res = process(data.rsp.results);
	      
        var menu = res.$menu;

        menu.click(function (e) { e.preventDefault(); });

        if (data.results && data.results.length > 0) {
          /* Fix for empty item appearing in the list */
          $("li:last a:empty", menu).remove();
        } else {
          $("li:last", menu)
            .attr("data-no-results", "")
            .html("<span style='padding-left:1em; cursor:default;'>No results found</span>");
        }

        return res;
      });
      }, afterSelect: function(item) {
	  if (isButtonLinkClicked == true) {
	      return;
	  }
      if (! item.no_results) {
        var form = $("#{{typeahead.base_id}}_query")
          .val(item["{{typeahead.json_key}}"])
          .closest("form");

        if ({*typeahead.before_submit or "$.noop"*}(form, item) !== "false")
          form.submit();
      }
    }, addItem: {name:"", no_results:true},
  });

  $('#{{typeahead.base_id}}_submit').click(function(e) {
    if ($('#{{typeahead.base_id}}_query').val() === '') {
      /* No typeahead result has been selected by the user */
      if($('#{{typeahead.base_id}}_search_field').val() === '' || "${{typeahead.allow_partial}}" !== "true") {
        /* Do not submit if also the typeahead content is empty or if we do not allow partial inputs */
        e.preventDefault();
      } else {
        /* Populate the search field with the user submitted values */
        $("#{{typeahead.base_id}}_query").val($('#{{typeahead.base_id}}_search_field').val());
      }
    }
  });

  /* Restore the original callbacks for new objects */
  for (var callback_name in _typeahead_overridden_callbacks)
    _typeahead_prototype[callback_name] = _typeahead_overridden_callbacks[callback_name];
</script>
</form>
